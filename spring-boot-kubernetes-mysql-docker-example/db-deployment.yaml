## Define a 'Persistent Voulume Claim'(PVC) for Mysql Storage, dynamically provisioned by cluster
#apiVersion: v1
#kind: PersistentVolumeClaim
#metadata:
#  name: mysql-pv-claim # name of PVC essential for identifying the storage data
#  labels:
#    app: mysql
#    tier: database
#spec:
#  accessModes:
#    - ReadWriteOnce   #This specifies the mode of the claim that we are trying to create.
#  resources:
#    requests:
#      storage: 1Gi    #This will tell kubernetes about the amount of space we are trying to claim.
#---
## Configure 'Deployment' of mysql server
#apiVersion: apps/v1
#kind: Deployment
#metadata:
#  name: mysql
#  labels:
#    app: mysql
#    tier: database
#spec:
#  selector: # mysql Pod Should contain same labels
#    matchLabels:
#      app: mysql
#      tier: database
#  strategy:
#    type: Recreate
#  template:
#    metadata:
#      labels: # Must match 'Service' and 'Deployment' selectors
#        app: mysql
#        tier: database
#    spec:
#      containers:
#        - image: mysql:8.0 # image from docker-hub
#          args:
#            - "--ignore-db-dir=lost+found" # Workaround for https://github.com/docker-library/mysql/issues/186
#          name: mysql
#          env:
#            - name: MYSQL_ROOT_PASSWORD
#              valueFrom :
#                secretKeyRef :
#                  name : mysql-secrets
#                  key :  password
#
#            - name: MYSQL_DATABASE # Setting Database Name from a 'ConfigMap'
#              valueFrom :
#                configMapKeyRef :
#                  name : db-config
#                  key :  dbName
#
#
#          ports:
#            - containerPort: 3306
#              name: mysql
#          volumeMounts:        # Mounting voulume obtained from Persistent Volume Claim
#            - name: mysql-persistent-storage
#              mountPath: /var/lib/mysql #This is the path in the container on which the mounting will take place.
#      volumes:
#        - name: mysql-persistent-storage # Obtaining 'vloume' from PVC
#          persistentVolumeClaim:
#            claimName: mysql-pv-claim
#---
## Define a 'Service' To Expose mysql to Other Services
#apiVersion: v1
#kind: Service
#metadata:
#  name: mysql  # DNS name
#  labels:
#    app: mysql
#    tier: database
#spec:
#  ports:
#    - port: 3306
#      targetPort: 3306
#  selector:       # mysql Pod Should contain same labels
#    app: mysql
#    tier: database
#  clusterIP: None  # We Use DNS, Thus ClusterIP is not relevant

#-------------------------------------------------------------
# PersistentVolumeClaim (PVC) for MySQL data - dynamically provisioned
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
  labels:
    app: mysql
    tier: database
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi   # adjust size as needed (e.g. 10Gi, 20Gi for production)
  # storageClassName: "standard"   # ← uncomment & set if not using default StorageClass

---
# Headless Service (required for stable DNS with StatefulSet)
apiVersion: v1
kind: Service
metadata:
  name: mysql
  labels:
    app: mysql
    tier: database
spec:
  ports:
    - port: 3306
      targetPort: 3306
      name: mysql
  selector:
    app: mysql
    tier: database
  clusterIP: None          # Headless → enables direct pod DNS like mysql-0.mysql.default.svc.cluster.local

---
# StatefulSet (preferred over Deployment for databases)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  labels:
    app: mysql
    tier: database
spec:
  serviceName: mysql       # Links to the headless service above
  replicas: 1              # Single instance (increase + use operator for HA)
  selector:
    matchLabels:
      app: mysql
      tier: database
  template:
    metadata:
      labels:
        app: mysql
        tier: database
    spec:
      containers:
        - name: mysql
          image: mysql:8.0   # or mysql:8.4 / 9.0 if you want newer minor version
          ports:
            - containerPort: 3306
              name: mysql
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: password
            - name: MYSQL_DATABASE
              valueFrom:
                configMapKeyRef:
                  name: db-config
                  key: dbName
            # Optional useful env vars (uncomment as needed):
            # - name: MYSQL_USER
            #   value: "appuser"
            # - name: MYSQL_PASSWORD
            #   valueFrom:
            #     secretKeyRef:
            #       name: appuser-secret
            #       key: password

#          resources:           # ← very important in real clusters
#            requests:
#              cpu: "500m"
#              memory: "1Gi"
#            limits:
#              cpu: "1500m"
#              memory: "2Gi"

          volumeMounts:
            - name: mysql-persistent-storage
              mountPath: /var/lib/mysql

          livenessProbe:       # Helps detect & restart crashed MySQL
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:      # Ensures pod only receives traffic when healthy
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

      volumes:
        - name: mysql-persistent-storage
          persistentVolumeClaim:
            claimName: mysql-pv-claim